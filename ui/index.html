<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SliceBuddy</title>
  <style>
    :root{
      /* Theme tuned to your reference look */
      --green: #4CAF50;
      --green-dark: #3f9e46;
      --bg: #f6f7f8;
      --panel: #ffffff;
      --border: #e6e8eb;
      --text: #111827;
      --muted: #6b7280;
      --shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      --radius: 14px;
      --radius-lg: 18px;
      --maxw: 860px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:var(--bg);
    }

    /* Layout */
    .app{
      height:100vh;
      display:grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: 64px 1fr;
      grid-template-areas:
        "sidebar header"
        "sidebar main";
    }

    .sidebar{
      grid-area: sidebar;
      background: var(--panel);
      border-right: 1px solid var(--border);
      padding: 18px 16px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 6px 6px 0 6px;
    }
    .logo{
      width:42px;height:42px;
      border-radius: 12px;
      background: var(--green);
      display:grid;place-items:center;
      box-shadow: 0 8px 14px rgba(76,175,80,.25);
      flex:0 0 auto;
    }
    .logo svg{ width:22px;height:22px; fill:#fff; }
    .brand h1{
      font-size:18px;
      margin:0;
      letter-spacing:.2px;
    }

    .new-btn{
      width:100%;
      background: var(--green);
      color:#fff;
      border:none;
      padding: 12px 14px;
      border-radius: 12px;
      font-weight: 700;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow: 0 10px 18px rgba(76,175,80,.25);
    }
    .new-btn:hover{ background: var(--green-dark); }
    .new-btn .plus{
      width:22px;height:22px;
      border-radius: 8px;
      background: rgba(255,255,255,.18);
      display:grid;place-items:center;
      font-size:18px;
      line-height:1;
      font-weight:900;
    }

    .sidebar-section-title{
      margin: 4px 6px 0 6px;
      font-size: 12px;
      letter-spacing: .12em;
      font-weight: 800;
      color: var(--muted);
      text-transform: uppercase;
    }

    .plans{
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
      padding-right: 4px;
    }
    .plan-item{
      border: 1px solid var(--border);
      background: #fbfbfc;
      border-radius: 14px;
      padding: 12px;
      cursor:pointer;
      transition: transform .04s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .plan-item:hover{
      border-color: #d9dde3;
      box-shadow: 0 8px 18px rgba(15,23,42,.06);
      transform: translateY(-1px);
    }
    .plan-item.active{
      border-color: rgba(76,175,80,.55);
      box-shadow: 0 10px 20px rgba(76,175,80,.16);
      background: #f4fbf5;
    }
    .plan-item .title{
      font-weight: 750;
      font-size: 14px;
      margin:0 0 6px 0;
      color: var(--text);
    }
    .plan-item .time{
      font-size: 12px;
      color: var(--muted);
      margin:0;
    }

    .header{
      grid-area: header;
      background: var(--green);
      color:#fff;
      border-bottom: 1px solid rgba(255,255,255,.22);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 18px;
    }
    .header-left{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 0;
    }
    .header-title{
      font-size: 18px;
      font-weight: 850;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 60vw;
    }
    .pill{
      background: rgba(255,255,255,.22);
      border: 1px solid rgba(255,255,255,.28);
      color:#fff;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing:.2px;
      flex: 0 0 auto;
    }
    .header-right{
      display:flex;
      align-items:center;
      gap:10px;
      opacity:.95;
      font-size: 12px;
      font-weight: 650;
    }

    .main{
      grid-area: main;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .scroll{
      flex: 1 1 auto;
      overflow:auto;
      padding: 22px 22px 90px;
    }

    .center{
      max-width: var(--maxw);
      margin: 0 auto;
    }

    /* Chat bubble */
    .user-bubble-wrap{
      display:flex;
      justify-content:flex-end;
      gap:12px;
      margin: 16px 0 18px;
    }
    .user-bubble{
      background: var(--green);
      color:#fff;
      padding: 14px 16px;
      border-radius: 18px;
      font-weight: 650;
      max-width: min(680px, 78%);
      box-shadow: 0 12px 22px rgba(76,175,80,.18);
      white-space: pre-wrap;
      line-height: 1.35;
    }
    .avatar{
      width:36px;height:36px;border-radius: 999px;
      background: #e5e7eb;
      border: 2px solid #fff;
      box-shadow: 0 10px 20px rgba(15,23,42,.12);
      flex:0 0 auto;
      display:grid;place-items:center;
      font-weight: 900;
      color:#111827;
    }

    /* Assistant card stack */
    .assistant-row{
      display:flex;
      gap:12px;
      align-items:flex-start;
      margin: 8px 0 22px;
    }
    .assistant-badge{
      width:36px;height:36px;border-radius: 999px;
      background: #e9f7ea;
      border: 1px solid rgba(76,175,80,.35);
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .assistant-badge svg{ width:18px;height:18px; fill: var(--green); }

    .stack{
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      gap:14px;
      max-width: var(--maxw);
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: 0 12px 26px rgba(15,23,42,.06);
      overflow:hidden;
    }
    .card-head{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 900;
      border-bottom: 1px solid var(--border);
      background: #fbfbfc;
    }
    .card-head .icon{
      width:26px;height:26px;border-radius: 10px;
      background: rgba(76,175,80,.12);
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .card-head .icon svg{ width:16px;height:16px; fill: var(--green); }
    .card-body{ padding: 14px 16px; }

    .muted{ color: var(--muted); }
    .p{ margin: 0; line-height:1.5; }

    /* Settings grid */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 18px;
    }
    .kv{
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #fbfbfc;
    }
    .kv .k{
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 850;
      margin-bottom: 6px;
    }
    .kv .v{
      font-size: 15px;
      font-weight: 850;
      color: var(--text);
    }

    /* List */
    ul{
      margin: 8px 0 0 18px;
      padding:0;
    }
    li{ margin: 6px 0; line-height:1.45; }

    /* Bottom input bar */
    .composer{
      position: sticky;
      bottom: 0;
      background: var(--green);
      border-top: 1px solid rgba(255,255,255,.22);
      padding: 14px 16px;
    }
    .composer-inner{
      max-width: 1100px;
      margin: 0 auto;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .input{
      flex: 1 1 auto;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.25);
      border-radius: 14px;
      padding: 12px 14px;
      color: #fff;
      outline: none;
      font-size: 14px;
      font-weight: 650;
    }
    .input::placeholder{ color: rgba(255,255,255,.86); }

    .send{
      width:46px;height:46px;
      border:none;
      border-radius: 14px;
      background: #fff;
      cursor:pointer;
      display:grid;place-items:center;
      box-shadow: 0 12px 22px rgba(15,23,42,.12);
    }
    .send svg{ width:18px;height:18px; fill: var(--green); }
    .send:hover{ transform: translateY(-1px); }

    /* Mobile */
    @media (max-width: 980px){
      .app{
        grid-template-columns: 1fr;
        grid-template-rows: 64px 1fr 0;
        grid-template-areas:
          "header"
          "main";
      }
      .sidebar{ display:none; }
      .header-title{ max-width: 62vw; }
      .scroll{ padding: 16px 14px 90px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo" title="Sliceregister to window">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M4 7.5A3.5 3.5 0 0 1 7.5 4h9A3.5 3.5 0 0 1 20 7.5v9A3.5 3.5 0 0 1 16.5 20h-9A3.5 3.5 0 0 1 4 16.5v-9Zm3.5-1.5A1.5 1.5 0 0 0 6 7.5v9A1.5 1.5 0 0 0 7.5 18h9A1.5 1.5 0 0 0 18 16.5v-9A1.5 1.5 0 0 0 16.5 6h-9Z"/>
            <path d="M9 9h6v6H9V9Z"/>
          </svg>
        </div>
        <h1>SliceBuddy</h1>
      </div>

      <button class="new-btn" id="newPlanBtn">
        <span class="plus">+</span>
        New Print Plan
      </button>

      <div class="sidebar-section-title">Recent Plans</div>
      <div class="plans" id="plansList"></div>
    </aside>

    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <div class="header-title" id="headerTitle">New Print Plan</div>
        <div class="pill">Active</div>
      </div>
      <div class="header-right">
        Local • LangGraph + RAG + FastAPI
      </div>
    </header>

    <!-- Main -->
    <main class="main">
      <div class="scroll" id="scroll">
        <div class="center">
          <div id="thread"></div>
        </div>
      </div>

      <!-- Composer -->
      <div class="composer">
        <div class="composer-inner">
          <input
            id="input"
            class="input"
            placeholder="Describe your model and include dimensions (e.g. 'functional bracket, height 120 width 30')."
            autocomplete="off"
          />
          <button class="send" id="sendBtn" title="Send">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M3.4 20.6 21 12 3.4 3.4l2.2 7.2L14 12 5.6 13.4l-2.2 7.2Z"/>
            </svg>
          </button>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ===== Config =====
    const API_URL = "http://127.0.0.1:8000/plan";

    // ===== State =====
    const STORAGE_KEY = "slicebuddy_recent_plans_v1";
    let plans = loadPlans();
    let activePlanId = plans[0]?.id || null;

    const els = {
      plansList: document.getElementById("plansList"),
      headerTitle: document.getElementById("headerTitle"),
      thread: document.getElementById("thread"),
      input: document.getElementById("input"),
      sendBtn: document.getElementById("sendBtn"),
      newPlanBtn: document.getElementById("newPlanBtn"),
      scroll: document.getElementById("scroll"),
    };

    // ===== Helpers =====
    function nowISO(){ return new Date().toISOString(); }
    function timeAgo(iso){
      const s = Math.floor((Date.now() - new Date(iso).getTime())/1000);
      if (s < 60) return "just now";
      const m = Math.floor(s/60);
      if (m < 60) return `${m} min ago`;
      const h = Math.floor(m/60);
      if (h < 24) return `${h} hours ago`;
      const d = Math.floor(h/24);
      return `${d} days ago`;
    }

    function loadPlans(){
      try{
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      }catch(e){
        return [];
      }
    }
    function savePlans(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(plans.slice(0, 20)));
    }

    function makeId(){
      return Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2);
    }

    function setActive(id){
      activePlanId = id;
      const p = plans.find(x => x.id === id);
      els.headerTitle.textContent = p?.title || "New Print Plan";
      renderSidebar();
      renderThread(p);
    }

    function renderSidebar(){
      els.plansList.innerHTML = "";
      if (!plans.length){
        els.plansList.innerHTML = `<div class="muted" style="padding:6px;">No plans yet.</div>`;
        return;
      }

      for (const p of plans){
        const div = document.createElement("div");
        div.className = "plan-item" + (p.id === activePlanId ? " active" : "");
        div.onclick = () => setActive(p.id);
        div.innerHTML = `
          <p class="title">${escapeHtml(p.title)}</p>
          <p class="time">${timeAgo(p.created_at)}</p>
        `;
        els.plansList.appendChild(div);
      }
    }

    function renderThread(plan){
      els.thread.innerHTML = "";
      if (!plan){
        // Empty state with a nice hint (not giant empty white nothing)
        els.thread.innerHTML = `
          <div style="margin-top:18px;" class="card">
            <div class="card-head">
              <div class="icon">${icon("cube")}</div>
              SliceBuddy is ready
            </div>
            <div class="card-body">
              <p class="p muted">Type a model description + dimensions in the green bar below.</p>
              <p class="p" style="margin-top:10px;"><b>Example:</b> <span class="muted">Functional bracket mount, small footprint, needs strength. height 120 width 30</span></p>
            </div>
          </div>
        `;
        return;
      }

      // User bubble
      const userRow = document.createElement("div");
      userRow.className = "user-bubble-wrap";
      userRow.innerHTML = `
        <div class="user-bubble">${escapeHtml(plan.user_text)}</div>
        <div class="avatar">G</div>
      `;
      els.thread.appendChild(userRow);

      // Assistant cards
      const assistantRow = document.createElement("div");
      assistantRow.className = "assistant-row";
      assistantRow.innerHTML = `
        <div class="assistant-badge" title="SliceBuddy">${icon("cube_green")}</div>
        <div class="stack" id="cards"></div>
      `;
      els.thread.appendChild(assistantRow);

      const cards = assistantRow.querySelector("#cards");
      if (plan.loading){
        cards.appendChild(card("Print Plan Analysis", icon("wand"), `<p class="p muted">Thinking…</p>`));
        return;
      }

      if (plan.error){
        cards.appendChild(card("Error", icon("warn"), `
          <p class="p"><b>Something broke:</b></p>
          <p class="p muted" style="margin-top:8px; white-space:pre-wrap;">${escapeHtml(plan.error)}</p>
        `));
        return;
      }

      const res = plan.response || {};
      const p = res.plan || {};

      // Analysis (summary)
      cards.appendChild(
        card("Print Plan Analysis", icon("doc"), `
          <p class="p">${escapeHtml(p.summary || "Here is your print plan.")}</p>
          <p class="p muted" style="margin-top:8px;">Based on your description and the project knowledge base.</p>
        `)
      );

      // Recommended Print Settings (grid)
      const settings = (p.slicer_settings && (p.slicer_settings.settings || p.slicer_settings)) || {};
      const settingsGrid = `
        <div class="grid">
          ${kv("Layer Height", fmt(settings.layer_height_mm, "mm"))}
          ${kv("Infill", fmt(settings.infill_percent, "%"))}
          ${kv("Walls", fmt(settings.walls, ""))}
          ${kv("Top/Bottom", fmt(settings.top_bottom_layers, ""))}
          ${kv("Supports", escapeHtml(settings.supports || "Auto (if needed)"))}
          ${kv("Brim", fmt(settings.brim_mm, "mm"))}
        </div>
        ${settings.notes?.length ? `<ul>${settings.notes.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>` : ""}
      `;
      cards.appendChild(card("Recommended Print Settings", icon("sliders"), settingsGrid));

      // Material
      const mat = p.material || {};
      cards.appendChild(
        card("Material Recommendation", icon("beaker"), `
          <p class="p"><b>Recommended:</b> ${escapeHtml(mat.recommended || "—")}</p>
          ${mat.reason ? `<p class="p" style="margin-top:8px;"><b>Why:</b> ${escapeHtml(mat.reason)}</p>` : ""}
          ${mat.alternatives?.length ? `<p class="p" style="margin-top:8px;"><b>Alternatives:</b> ${escapeHtml(mat.alternatives.join(", "))}</p>` : ""}
        `)
      );

      // Orientation & supports strategy
      const ori = p.orientation || {};
      cards.appendChild(
        card("Orientation & Support Strategy", icon("compass"), `
          <p class="p"><b>Recommended:</b> ${escapeHtml(ori.recommended || "—")}</p>
          ${ori.reason ? `<p class="p" style="margin-top:8px;"><b>Why:</b> ${escapeHtml(ori.reason)}</p>` : ""}

          ${ori.tradeoffs?.length ? `<p class="p" style="margin-top:10px;"><b>Trade-offs:</b></p>
            <ul>${ori.tradeoffs.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>` : ""}

          <p class="p" style="margin-top:10px;"><b>Supports:</b> ${escapeHtml((settings.supports || "Auto (only if needed)"))}</p>

          ${ori.bed_adhesion_tips?.length ? `<p class="p" style="margin-top:10px;"><b>Bed adhesion tips:</b></p>
            <ul>${ori.bed_adhesion_tips.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>` : ""}
        `)
      );

      // Risks
      const risks = p.risks || {};
      const riskItems = risks.items || [];
      const mitigations = risks.mitigations || [];
      const risksHtml = `
        ${riskItems.length
          ? `<ul>${riskItems.map(r => `<li><b>${escapeHtml(r.severity || "risk")}</b>: ${escapeHtml(r.why || "")}</li>`).join("")}</ul>`
          : `<p class="p muted">No major risks detected from the current inputs.</p>`}
        ${mitigations.length
          ? `<p class="p" style="margin-top:10px;"><b>Mitigations:</b></p><ul>${mitigations.map(m=>`<li>${escapeHtml(m)}</li>`).join("")}</ul>`
          : ``}
      `;
      cards.appendChild(card("Risks & Mitigations", icon("warn"), risksHtml));

      // Optional: warnings/assumptions in a neat way (not shouting rules)
      const warnings = res.warnings || [];
      const assumptions = res.assumptions || [];
      if (warnings.length || assumptions.length){
        cards.appendChild(card("Assumptions & Notes", icon("info"), `
          ${assumptions.length ? `<p class="p"><b>Assumptions</b></p><ul>${assumptions.map(a=>`<li>${escapeHtml(a)}</li>`).join("")}</ul>` : ""}
          ${warnings.length ? `<p class="p" style="margin-top:10px;"><b>Warnings</b></p><ul>${warnings.map(w=>`<li>${escapeHtml(w)}</li>`).join("")}</ul>` : ""}
        `));
      }

      // Scroll to bottom
      setTimeout(() => els.scroll.scrollTo({ top: els.scroll.scrollHeight, behavior: "smooth" }), 50);
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function fmt(val, suffix){
      if (val === undefined || val === null || val === "") return "—";
      const n = Number(val);
      if (Number.isFinite(n)){
        const pretty = (Math.abs(n) >= 10 || suffix === "%") ? n.toString() : n.toFixed(2);
        return `${pretty}${suffix ? " " + suffix : ""}`.trim();
      }
      return escapeHtml(val);
    }

    function kv(k,v){
      return `
        <div class="kv">
          <div class="k">${escapeHtml(k)}</div>
          <div class="v">${escapeHtml(v)}</div>
        </div>
      `;
    }

    function card(title, iconSvg, bodyHtml){
      const wrap = document.createElement("div");
      wrap.className = "card";
      wrap.innerHTML = `
        <div class="card-head">
          <div class="icon">${iconSvg}</div>
          ${escapeHtml(title)}
        </div>
        <div class="card-body">${bodyHtml}</div>
      `;
      return wrap;
    }

    function icon(which){
      if (which === "cube") return `
        <svg viewBox="0 0 24 24"><path d="M12 2 3 6.5V17.5L12 22l9-4.5V6.5L12 2Zm7 15.2-6 3V14l6-3v6.2ZM11 20.2l-6-3V11l6 3v6.2Zm.5-8L5.2 9 12 5.8 18.8 9 12.5 12.2Zm7.5-5.2-6 3-6-3L12 3.8 19 7Z"/></svg>
      `;
      if (which === "cube_green") return `
        <svg viewBox="0 0 24 24"><path d="M12 2 3 6.5V17.5L12 22l9-4.5V6.5L12 2Zm7 15.2-6 3V14l6-3v6.2ZM11 20.2l-6-3V11l6 3v6.2Zm.5-8L5.2 9 12 5.8 18.8 9 12.5 12.2Zm7.5-5.2-6 3-6-3L12 3.8 19 7Z"/></svg>
      `;
      if (which === "doc") return `
        <svg viewBox="0 0 24 24"><path d="M6 2h9l5 5v15a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm8 1.5V8h4.5L14 3.5ZM7 11h10v2H7v-2Zm0 4h10v2H7v-2Zm0 4h7v2H7v-2Z"/></svg>
      `;
      if (which === "sliders") return `
        <svg viewBox="0 0 24 24"><path d="M7 6h14v2H7V6ZM3 7a2 2 0 1 0 4 0 2 2 0 0 0-4 0ZM7 16h14v2H7v-2ZM3 17a2 2 0 1 0 4 0 2 2 0 0 0-4 0ZM7 11h14v2H7v-2ZM3 12a2 2 0 1 0 4 0 2 2 0 0 0-4 0Z"/></svg>
      `;
      if (which === "beaker") return `
        <svg viewBox="0 0 24 24"><path d="M9 3h6v2h-1v4.1l4.7 7.8A3 3 0 0 1 16.1 21H7.9a3 3 0 0 1-2.6-4.1L10 9.1V5H9V3Zm2 6.7-4 6.7a1 1 0 0 0 .9 1.5h8.2a1 1 0 0 0 .9-1.5l-4-6.7V5h-2v4.7Z"/></svg>
      `;
      if (which === "compass") return `
        <svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm0 18a8 8 0 1 1 .001-16.001A8 8 0 0 1 12 20Zm3.9-12.9-2.3 6.4-6.4 2.3 2.3-6.4 6.4-2.3Zm-4.2 3.1-.7 2 2-.7.7-2-2 .7Z"/></svg>
      `;
      if (which === "warn") return `
        <svg viewBox="0 0 24 24"><path d="M12 2 1 21h22L12 2Zm0 6 1 8h-2l1-8Zm-1 10h2v2h-2v-2Z"/></svg>
      `;
      if (which === "info") return `
        <svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 15h-2v-6h2v6Zm0-8h-2V7h2v2Z"/></svg>
      `;
      if (which === "wand") return `
        <svg viewBox="0 0 24 24"><path d="M3 21 14 10l-1-1 11-6-6 11-1-1L6 24 3 21Zm8-10 2 2-7 7-2-2 7-7Z"/></svg>
      `;
      return "";
    }

    // ===== Parsing user input (chat style) =====
    // Accept: "height 120 width 30" or "h=120 w=30" or "120x30" or "height_mm:120 width_mm:30"
    function parseUserText(text){
      const out = { description: text.trim() };

      // height
      const hMatch =
        text.match(/\bheight(?:_mm)?\s*[:=]?\s*([0-9]+(?:\.[0-9]+)?)\b/i) ||
        text.match(/\bh\s*[:=]\s*([0-9]+(?:\.[0-9]+)?)\b/i);
      // width
      const wMatch =
        text.match(/\bwidth(?:_mm)?\s*[:=]?\s*([0-9]+(?:\.[0-9]+)?)\b/i) ||
        text.match(/\bw\s*[:=]\s*([0-9]+(?:\.[0-9]+)?)\b/i);

      // "120x30"
      const xMatch = text.match(/\b([0-9]+(?:\.[0-9]+)?)\s*[x×]\s*([0-9]+(?:\.[0-9]+)?)\b/i);

      if (hMatch) out.height_mm = Number(hMatch[1]);
      if (wMatch) out.width_mm = Number(wMatch[1]);
      if ((!out.height_mm || !out.width_mm) && xMatch){
        out.height_mm = out.height_mm ?? Number(xMatch[1]);
        out.width_mm  = out.width_mm  ?? Number(xMatch[2]);
      }

      // If user typed "height 120 width 30", strip those tokens from description for nicer titles
      const cleaned = text
        .replace(/\bheight(?:_mm)?\s*[:=]?\s*[0-9]+(?:\.[0-9]+)?\b/ig,"")
        .replace(/\bwidth(?:_mm)?\s*[:=]?\s*[0-9]+(?:\.[0-9]+)?\b/ig,"")
        .replace(/\bh\s*[:=]\s*[0-9]+(?:\.[0-9]+)?\b/ig,"")
        .replace(/\bw\s*[:=]\s*[0-9]+(?:\.[0-9]+)?\b/ig,"")
        .replace(/\b([0-9]+(?:\.[0-9]+)?)\s*[x×]\s*([0-9]+(?:\.[0-9]+)?)\b/ig,"")
        .replace(/\s+/g," ")
        .trim();

      out.description = cleaned || "Untitled model";
      return out;
    }

    // ===== API call =====
    async function generatePlan(userText){
      const parsed = parseUserText(userText);

      // Create plan object immediately (UI feels responsive)
      const plan = {
        id: makeId(),
        title: parsed.description.slice(0, 26) + (parsed.description.length > 26 ? "…" : ""),
        user_text: userText.trim(),
        created_at: nowISO(),
        loading: true,
        response: null,
        error: null,
      };
      plans.unshift(plan);
      savePlans();
      setActive(plan.id);

      // Validate minimal input
      if (!Number.isFinite(parsed.height_mm) || !Number.isFinite(parsed.width_mm)){
        plan.loading = false;
        plan.error = "Please include height and width in mm.\nExample: height 120 width 30";
        savePlans();
        renderSidebar();
        renderThread(plan);
        return;
      }

      try{
        const payload = {
          description: parsed.description,
          height_mm: parsed.height_mm,
          width_mm: parsed.width_mm
        };

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok){
          const t = await res.text();
          throw new Error(`HTTP ${res.status}\n${t}`);
        }

        const json = await res.json();
        plan.loading = false;
        plan.response = json;
        plan.title = (json?.plan?.summary ? json.plan.summary.replace(/^Draft plan for:\s*/i,"") : plan.title).slice(0, 28) + "…";
        savePlans();
        renderSidebar();
        renderThread(plan);
      }catch(err){
        plan.loading = false;
        plan.error = String(err?.message || err);
        savePlans();
        renderSidebar();
        renderThread(plan);
      }
    }

    // ===== Events =====
    els.sendBtn.addEventListener("click", () => {
      const t = els.input.value.trim();
      if (!t) return;
      els.input.value = "";
      generatePlan(t);
    });

    els.input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        els.sendBtn.click();
      }
    });

    els.newPlanBtn.addEventListener("click", () => {
      activePlanId = null;
      els.headerTitle.textContent = "New Print Plan";
      renderSidebar();
      renderThread(null);
      els.input.focus();
    });

    // ===== Init =====
    renderSidebar();
    if (activePlanId){
      setActive(activePlanId);
    }else{
      renderThread(null);
    }
  </script>
</body>
</html>